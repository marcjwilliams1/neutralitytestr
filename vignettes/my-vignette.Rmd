---
title: "NeutralityTest.R: Testing a neutral evolutionary model on cancer sequencing data "
author: "Marc Williams"
date: "`r Sys.Date()`"
#output: rmarkdown::html_vignette
output: pdf_document
fig_caption: yes
vignette: >
  %\VignetteIndexEntry{Vignette Title}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---

## Load package

To load the package content run the script `neutralitytestr.R`. This will load all functions and some testdata files. Make sure that you have installed the following required packages: `pracma`, `ggplot2`, `ggpmisc`,`scales`, `cowplot` and `dplyr`. First of all set the directory to the package directory.

```{r, echo = FALSE,  warning = FALSE}
packagedir<-"/Users/marcwilliams/Google Drive/R-packages/neutralitytestr/"
```

```{r,message = FALSE,  warning = FALSE}
setwd(packagedir)
source("R/neutralitytestr.R")
library(neutralitytestr)
```

The test data files include 2 simulated VAF distributions, one under a neutral evolutionary model and one with a non neutral evolutionary model. The test data are vectors of variant allele frequency, and are named VAFselection and VAFneutral. First of all we print the first few elements of one of these vectors.

```{r}
head(VAFselection)
```

## `neutralitytest` object

The basic functionality of the TestingNeutrality.R package is achieved by creating a `neutralitytest` object. The `neutralitytest` object contains a range of metrics to test for neutrality, and makes plotting histograms and cumulative distributions to visualize the output easy. The neutralitytest function takes a vector of VAFs and an upper and lower limit for the frequency range over which we wish to test whether the data is consistent with a neutral model, and then calculates all 4 metrics.

```{r}
s <- neutralitytest(VAFselection, fmin = 0.05, fmax = 0.4)
```
We can the print a summary of the neutralitytest object for the synthetic data with selection. This prints out all values and associated p-values for all the metrics. The p-values are the p-values under the null model of neutral evolution.

```{r}
summary(s)
```
And we can do the same for the neutral synthetic data.
```{r}
n <- neutralitytest(VAFneutral,fmin = 0.05, fmax = 0.4)
summary(n)
```

## Plotting

The `neutralitytest` object makes plotting simple. Plotting uses `ggplot`, so plots can easily modified using the usual `ggplot` syntax. First of all we can plot a histogram of the VAFs.

```{r, fig.show='hold',fig.width = 4, fig.height=3, warning = FALSE, fig.align='center'}
vaf_histogram(n)
```

We can also plot the cumulative distribution along with the least squares best fit line, from which we get the $R^2$ value and the estimated mutation rate.

```{r, fig.show='hold',fig.width = 4, fig.height=3, warning = FALSE, fig.align='center'}
lsq_plot(n)
```

And finally the normalized cumulative distribution, which is used to calculate the kolmogorov distance and the area metrics.
```{r, fig.show='hold',fig.width = 4, fig.height=3, warning = FALSE, fig.align='center'}
normalized_plot(n)
```

Invoking the plot command will plot all 3 plots together, which can be saved to a named output.
```{r, warning = FALSE}
gout <- plot_all(s)
ggsave(filename = "test.pdf", gout, height = 5, width = 15)
```

## Summary of neutrality metrics
`neutralitytestr.R` calculates values for 4 different metrics from which we can deduce whether a given dataset is likely to be driven by a neutral evolutionary process or not. These metrics are all based the cumulative distributions of mutations, M(f), which under a neutral model follows the following equation:
\begin{equation}
M(f) = \frac{\mu}{\beta} \left (\frac{1}{f} - \frac{1}{f_{max}} \right)
\end{equation}
where $f$ is the frequency of mutations, $\mu$ is the mutation rate, $\beta$ is the proportion of divisions that results in 2 surviving offspring and $f_{max}$ is the maximum frequency over which we conduct the analysis. The first metric we calculate is the $R^2$ value from the best fit line of the linear model described by equation (1).

The other metrics are based on a normalized version of equation (1) which removes the mutation rate dependency. The equation for the normalized $M(f)$ is
\begin{equation}
M(f) = \frac{\frac{1}{f}-\frac{1}{f_{max}}} {\frac{1}{f_{min}} - \frac{1}{f_{max}}}
\end{equation}
Theoretically, any dataset can be compared to the curve described by equation (2). We can then calculate the area between the data and this curve, the kolmogorov distance between the two and the mean distance of all points and this curve. For further details on the theoretical background see _Williams, Werner et al. Nat. Gen. 2016._
